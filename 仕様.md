# Camera Live Applications 仕様

**生成者:** GitHub Copilot (Agent, GPT-4o)  
**作成日:** 2025年6月15日  
**最終更新:** 2025年7月1日 - カメラ切り替え機能追加

## 動作環境
- **ハードウェア**:
  - Raspberry Pi 5 RAM16GB
  - Raspberry Pi Camera V2（複数カメラ対応）
- **ソフトウェア**:
  - Raspberry Pi OS Bookworm
  - Python 3.11
- **ストレージ**:
  - Lexar Professional Gold MicroSDXC 128GB

## 開発環境
- **ソフトウェア**:
  - VSCode 1.101.0

## 必要なライブラリ
- `astropy`: FITSファイル保存用。
- `Pillow`: JPEG/PNG保存用。
- `piexif`: EXIFデータ操作用。
- `cv2`: OpenCVライブラリ。

## 処理の概要

### モードについて

#### Live View Mode
- リアルタイムでカメラ映像を表示。
- 加算処理やダークフレーム減算は行わず、シンプルなプレビューを提供。
- カメラ切り替えによる複数カメラ対応。
- **対応メソッド:** `main()`

#### Live Stack Mode
- フレームを加算してノイズを軽減し、画質を向上。
- 最新フレームを基準に過去フレームを位置合わせして加算。
- ダークフレーム減算を実施。
- カメラ切り替えによる複数カメラ対応。
- **対応メソッド:** `LiveStack.process_stack()`

### スタックを実現するための処理方法

#### リングバッファ
- **撮影用リングバッファ**: 最大100フレームを保持し、最新フレームを基準に過去フレームを位置合わせ。
  - **対応メソッド:** `LiveStack.add_to_buffer()`
- **ダークフレーム用リングバッファ**: ダークフレームを加算平均して作成。
  - **対応メソッド:** `LiveStack.set_dark_frame()`

#### ダークフレーム作成までの流れ
1. ダークフレーム取得モードで複数フレームを撮影。
2. 撮影したフレームをリングバッファに追加。
3. バッファ内のフレームを加算平均してダークフレームを作成。
- **対応メソッド:** `LiveStack.set_dark_frame()`

#### 撮影画像からダークフレームを引いてスタックする流れ
1. 最新フレームを基準に設定。
2. ダークフレームを減算し、負の値をクリッピング。
3. 過去フレームを位置合わせして加算。
4. スタック数を更新。
- **対応メソッド:** `LiveStack.process_stack()`

#### 位置合わせについて
- 最新フレームを基準にテンプレートマッチングを実施。
- 相関値が閾値を超えた場合、位置合わせを成功と判断。
- アフィン変換を用いて過去フレームを基準フレームに合わせる。
- **対応メソッド:** `LiveStack.add_frame()`

#### スタック数の決定方法
- 有効なフレーム数をカウントしてスタック数を更新。
- 画面の10%以上が白くなる場合、スタック処理を終了。
- **対応メソッド:** `LiveStack.process_stack()`

## クラスとメソッド

### `LiveStack` クラス
リアルタイムのフレームスタッキングを管理するクラス。

#### メソッド一覧
- **`__init__(max_frames=100, verbose=False)`**:
  - リングバッファを初期化し、スタック処理を準備。
  - 引数:
    - `max_frames`: リングバッファの最大フレーム数。
    - `verbose`: デバッグ出力の有効化。
- **`reset()`**:
  - スタック状態をリセット。
- **`add_frame(frame)`**:
  - フレームをスタックに追加。
  - 引数:
    - `frame`: 加算するフレーム。
- **`add_to_buffer(frame)`**:
  - フレームをリングバッファに追加。
  - 引数:
    - `frame`: バッファに追加するフレーム。
- **`process_stack()`**:
  - スタック処理を実行。
  - 戻り値:
    - 加算後のフレーム。
- **`set_dark_frame(frame)`**:
  - ダークフレームを加算平均して設定。
  - 引数:
    - `frame`: ダークフレームとして使用するフレーム。

### `SettingsMenu` クラス
設定メニューのUI管理とキー入力処理を行うクラス。

#### メソッド一覧
- **`__init__()`**:
  - 設定項目とデフォルト値を初期化。
- **`handle_key(key)`**:
  - カーソルキーとEnter/ESCキーの入力処理。
  - 引数:
    - `key`: OpenCVのwaitKey()で取得したキー値。
  - 戻り値:
    - `bool`: メニューがキーを処理した場合True。
- **`change_value(direction)`**:
  - 選択中の設定項目の値を変更。
  - 引数:
    - `direction`: 変更方向（1: 増加, -1: 減少）。
- **`get_exposure_text(exposure_us)`**:
  - 露出時間をわかりやすい文字列に変換。
  - 引数:
    - `exposure_us`: マイクロ秒単位の露出時間。
  - 戻り値:
    - `str`: "1/60"や"2s"形式の文字列。
- **`draw_menu(frame)`**:
  - 設定メニューをフレームに描画。
  - 引数:
    - `frame`: 描画対象のフレーム。
  - 戻り値:
    - `frame`: メニューが描画されたフレーム。
- **`get_current_values()`**:
  - 現在の設定値を辞書で取得。
  - 戻り値:
    - `dict`: 設定値の辞書。
- **`set_current_values(camera, gain, exposure, max_frames, stack_mode, info_display=True)`**:
  - 設定値を更新。
  - 引数:
    - `camera`: カメラ番号（NEW）。
    - `gain`: ゲイン値。
    - `exposure`: 露出時間（マイクロ秒）。
    - `max_frames`: 最大フレーム数。
    - `stack_mode`: スタックモードのON/OFF。
    - `info_display`: 情報表示のON/OFF。

### `CameraConfig` クラス（NEW）
カメラ設定と初期化を管理するクラス。

#### メソッド一覧
- **`create_fast_camera(camera_num=0)`**:
  - 高速プレビュー用カメラを作成。
  - 引数:
    - `camera_num`: カメラ番号（0または1）。
  - 戻り値:
    - `Picamera2`: 初期化済みカメラオブジェクト。
- **`create_low_light_camera(camera_num=0)`**:
  - 低照度撮影用カメラを作成。
  - 引数:
    - `camera_num`: カメラ番号（0または1）。
  - 戻り値:
    - `Picamera2`: 初期化済みカメラオブジェクト。
- **`create_still_camera(camera_num=0)`**:
  - 静止画撮影用カメラを作成。
  - 引数:
    - `camera_num`: カメラ番号（0または1）。
  - 戻り値:
    - `Picamera2`: 初期化済みカメラオブジェクト。

### `save_fits(image, filename, metadata)` 関数
FITS形式で画像を保存し、メタデータを付与する関数。
- 引数:
  - `image`: 保存する画像。
  - `filename`: 保存先のファイル名。
  - `metadata`: FITSヘッダーに追加するメタデータ。

### `create_camera_safely(camera_num, gain, exposure, low_light_mode)` 関数（NEW）
エラーハンドリング付きでカメラを安全に作成する関数。
- 引数:
  - `camera_num`: カメラ番号（0または1）。
  - `gain`: ゲイン値。
  - `exposure`: 露出時間（マイクロ秒）。
  - `low_light_mode`: 低照度モードのON/OFF。
- 戻り値:
  - `Picamera2`: 初期化済みカメラオブジェクト（失敗時はNone）。

### `main()` 関数
アプリケーションのエントリーポイント。カメラの初期化、フレーム取得、キー入力処理を実行。

## キー操作

### 共通操作
- `q`: アプリケーション終了。
- `m`: 設定メニューの開閉。
- `i`: 情報表示のON/OFF切り替え。
- `c`: カメラ切り替え（0と1の間でトグル）（NEW）。
- `0`/`1`: カメラ番号直接指定（NEW）。

### Live View Mode
- `s`: 画像保存。
- `d`: ダークフレーム取得。

### Live Stack Mode
- `t`: Live StackモードのON/OFF切り替え。
- `r`: スタックリセット。
- `f`: FITS形式で画像保存。
- `j`: JPEG形式で画像保存。
- `p`: PNG形式で画像保存。

### 従来のキー操作（後方互換性）
- `+`/`-`: ゲイン調整。
- `2`〜`9`: シャッター速度変更（`0`/`1`はカメラ番号指定で使用）。

### 設定メニュー操作
設定メニューが開いている時の専用操作：
- **上下矢印**: 設定項目選択（Camera → Gain → Exposure → Max Frames → Stack Mode → Info Display）。
- **左右矢印**: 選択項目の値変更。
- **Enter**: 設定適用してメニューを閉じる。
- **ESC**: 変更をキャンセルしてメニューを閉じる。

#### 設定可能項目
1. **Camera**: 0/1 - カメラ番号の切り替え（NEW）
2. **Gain**: 1.0～8.0（0.5刻み） - カメラ感度
3. **Exposure**: 10秒～1/2000秒（15段階プリセット） - 露出時間
4. **Max Frames**: 1～100（1刻み） - スタッキング最大フレーム数
5. **Stack Mode**: ON/OFF - LiveStackモードの切り替え
6. **Info Display**: ON/OFF - 画面上の情報表示切り替え

## 初期化処理

#### シャッター速度変更時
- ダークフレームとリングバッファを初期化。
  - **対応メソッド:** `main()`

#### ゲイン変更時
- ダークフレームとリングバッファを初期化。
  - **対応メソッド:** `main()`

#### カメラ切り替え時（NEW）
- 現在のカメラを停止・解放。
- 新しいカメラを初期化。
- ダークフレームとリングバッファを初期化。
- スタック状態をリセット。
- 切り替え失敗時は元のカメラに自動復帰。
  - **対応メソッド:** `main()`

## 注意点
- FITS保存時のメタデータはFITS標準に準拠。
- FITS保存では画面表示のオーバーレイテキストが除外され、元のフレームデータのみが保存される。
- JPEG保存時にはEXIFデータが付与され、PNG保存時には文字が含まれないフレームを保存。
- ダークフレーム取得はLive Viewモードでのみ可能。
- カメラ切り替え時は全てのバッファとスタック状態がリセットされる。
- カメラ切り替え機能は現在0と1の2つのカメラに対応。

## 最新の改善点（2025/07/01）
- **カメラ切り替え機能**: `c`キーでカメラ0と1の間でトグル切り替え、`0`/`1`キーで直接カメラ番号指定が可能。
- **設定メニューにカメラ項目追加**: 設定メニューからカメラ番号の切り替えが可能。
- **カメラ切り替え時の安全性向上**: 切り替え失敗時は元のカメラに自動復帰、バッファとスタック状態を自動リセット。
- **メニューとキー操作の双方向同期**: カメラ切り替えがメニューとキー操作で常に同期。
- **情報表示切り替え機能**: `i`キーで画面上のテキスト表示をリアルタイムでON/OFF可能。
- **FITS保存の改善**: LiveStackモードではスタック済み画像データ、LiveViewモードでは元フレームデータを保存し、いずれもオーバーレイテキストは除外。
- **双方向同期強化**: キー操作と設定メニューの全設定項目が相互に同期。
